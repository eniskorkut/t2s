datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
  enable_experimental_decimal = true
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password_hash String
  role          String   @default("user")
  created_at    DateTime @default(now())
  
  // Relations
  sessions          ChatSession[]
  schema_definitions SchemaDefinition[]
  saved_queries     UserSavedQuery[]

  @@map("users")
}

model PasswordResetToken {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  email      String
  expires_at DateTime
  created_at DateTime @default(now())

  @@map("password_reset_tokens")
}

// App Domain Models
model ChatSession {
  id         String   @id @default(uuid())
  title      String
  user_id    Int
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  is_pinned  Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt
  messages   ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id          Int         @id @default(autoincrement())
  session_id  String
  session     ChatSession @relation(fields: [session_id], references: [id], onDelete: Cascade)
  role        String
  content     String
  sql_query   String?
  data        String?
  plotly_json String?
  created_at  DateTime    @default(now())

  @@map("chat_messages")
}

model SchemaDefinition {
  id          Int      @id @default(autoincrement())
  user_id     Int
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  ddl_content String
  created_at  DateTime @default(now())

  @@map("schema_definitions")
}

model UserSavedQuery {
  id         Int      @id @default(autoincrement())
  user_id    Int
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  question   String
  sql_query  String
  saved_at   DateTime @default(now())
  is_trained Boolean  @default(false)

  @@map("user_saved_queries")
}

// Business Domain Models
model Employee {
  id           Int      @id @default(autoincrement())
  name         String
  department   String
  salary       Decimal  @db.Decimal(10, 2)
  hire_date    DateTime @map("hire_date") @db.Date
  
  // Relations
  personal_info EmployeePersonalInfo?
  projects      EmployeeProject[]

  @@map("employees")
}

model EmployeePersonalInfo {
  id          Int      @id @default(autoincrement())
  employee_id Int      @unique
  email       String
  phone       String?
  address     String?
  birth_date  DateTime? @map("birth_date") @db.Date

  // Relations
  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("employee_personal_info")
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  start_date  DateTime? @map("start_date") @db.Date
  end_date    DateTime? @map("end_date") @db.Date
  budget      Decimal?  @db.Decimal(12, 2)

  // Relations
  employees   EmployeeProject[]

  @@map("projects")
}

model EmployeeProject {
  id           Int @id @default(autoincrement())
  employee_id  Int
  project_id   Int
  role         String?
  hours_worked Int? @map("hours_worked")

  // Relations
  employee     Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  project      Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@unique([employee_id, project_id])
  @@map("employee_projects")
}
